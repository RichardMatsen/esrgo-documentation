(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{212:function(e,t,a){e.exports=a.p+"assets/img/sequenced-process-commands.6b761a47.jpg"},213:function(e,t,a){e.exports=a.p+"assets/img/interface-hierarchy.c9f94175.png"},220:function(e,t,a){"use strict";a.r(t);var s=a(0),r=Object(s.a)({},function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"content"},[e._m(0),e._v(" "),e._m(1),e._v(" "),s("p",[e._v("The dataflow has a distinct sequence of steps, so it was logical to break the structure down by these steps. A command object wraps each step")]),e._v(" "),s("figure",[s("img",{directives:[{name:"img",rawName:"v-img"}],attrs:{src:a(212),alt:"sequenced-process-commands"}}),e._v(" "),e._m(2)]),e._v(" "),e._m(3),e._v(" "),s("p",[e._v("Commands allow the runtime steps to be composed externally. The program host is a Console Application, so the internal steps that need to be run can be specified as command line parameters. For example, the transport layer could be FTP or web service (or none if the files were brought to the LOCAL/IN directory by some other external means). The data required might vary by client, so the appropriate set of data stream commands could also be chosen in the command line.")]),e._v(" "),e._m(4),e._v(" "),s("p",[e._v("One of the most volatile areas of the application was matching the ESR model to the HealthRoster model. When live client data was processed, we encountered additional requirements for transformations in the data model. We wanted to isolate the code for these transformations, and also provide some activity tracking per process run.")]),e._v(" "),s("p",[e._v("The Event module was responsible for evaluating the incoming data and classifying the events required to process it. Event modelling gave us")]),e._v(" "),e._m(5),e._v(" "),e._m(6),e._v(" "),s("p",[e._v("Events are evaluated by a set of factory methods which have the same signature - staging record parameter and IEnumerable yield of event records. The events to be evaluated depend upon the file format, so the list of factories to be applied is composable in the class calling the event evaluator (List of Func<TIn, TOut>).")]),e._v(" "),e._m(7),e._v(" "),s("p",[e._v("The full snapshot file has 100,000 record which is large enough to justify pipelining the records using the IEnumerable and yield return pattern. Constructing pipeline filter functions is straightforward as long as care is taken to use the yield keyword a all return points.")]),e._v(" "),e._m(8),e._v(" "),s("p",[e._v("Pipeline functions process a single record at a time, but some need visibility of a set of records, for example the Implicit Close event evaluator needs to see what has previously processed.")]),e._v(" "),s("p",[e._v("To implement this, we provide a cache of the minimum information information required, which is a hash set cache of the entity keys. This is actually a two-level cache with a Dictionary keyed on Id containing the hash sets, to allow access to key sets or individual keys.")]),e._v(" "),e._m(9),e._v(" "),s("p",[e._v("Entity Framework is the ORM to the database, and the DbContext object of EF provides a lot of the Repository and UnitOfWork functionality.")]),e._v(" "),e._m(10),e._v(" "),s("p",[e._v("Repositories are used between the process logic and EF to decouple, so that mocks can be used in tests. They also make the database access methods more explicit, and provide encapsulation of caching and other performance enhancements such as SqlBulkCopy.")]),e._v(" "),e._m(11),e._v(" "),s("p",[e._v("Since there are 14 different record types in the data source, the repositories are structured around aggregate roots to reduce code clutter, i.e.")]),e._v(" "),e._m(12),e._v(" "),e._m(13),e._v(" "),s("p",[e._v("Each of these classes has a manageable amount of code, and a feel of structural consistency (cohesion). However, when loading data in from a CSV source, all three repositories are required so there is also an EventRepository that composes these three repositories together. For example, a single Insert method on the EventRepository will choose which sub-repository to send the data to, based on the interfaces implemented by the object.")]),e._v(" "),e._m(14),e._v(" "),s("p",[e._v("The DataFixRepository, also used by the EventRepository, retrieves data from a local XML file instead of the database. This application also needs to be ready for use with an Enterprise Service Bus being developed. It is expected that the ReferenceData will be accessed via a Master Data Service on the ESB rather than directly to the database.")]),e._v(" "),e._m(15),e._v(" "),s("p",[e._v("There are several interfaces and abstract classes in the the model which enable the event sourcing and related code.")]),e._v(" "),e._m(16),e._v(" "),s("figure",[s("img",{directives:[{name:"img",rawName:"v-img"}],attrs:{src:a(213),alt:"interface-hierarchy"}}),e._v(" "),e._m(17)]),e._v(" "),e._m(18),e._v(" "),s("p",[e._v("At the attribute level the data in the ESR Payroll system and the HealthRoster rostering system are fairly similar, but the business focus of each system is quite different so transformations were required to match the models.")]),e._v(" "),s("p",[e._v("For example, both systems have a temporal versions of records (with start and end dates) but the usage differs, e.g:")]),e._v(" "),e._m(19),e._v(" "),s("MiniMap")],1)},[function(){var e=this.$createElement,t=this._self._c||e;return t("h1",{attrs:{id:"structure-and-design"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#structure-and-design","aria-hidden":"true"}},[this._v("#")]),this._v(" Structure and Design")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"commands"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#commands","aria-hidden":"true"}},[this._v("#")]),this._v(" Commands")])},function(){var e=this.$createElement,t=this._self._c||e;return t("figcaption",[t("i",[this._v("(click to enlarge)")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"command-pattern-uses-composable-runtime"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#command-pattern-uses-composable-runtime","aria-hidden":"true"}},[this._v("#")]),this._v(" Command Pattern Uses - Composable Runtime")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"events"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#events","aria-hidden":"true"}},[this._v("#")]),this._v(" Events")])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("Volatile code isolation")]),this._v(" "),t("li",[this._v("Correct execution order regardless of data presentation order (e.g. reference data before transactional data)")]),this._v(" "),t("li",[this._v("A person level audit trail that fits with the user mental model")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"event-factory-methods"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#event-factory-methods","aria-hidden":"true"}},[this._v("#")]),this._v(" Event Factory Methods")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"pipeline-architecture"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#pipeline-architecture","aria-hidden":"true"}},[this._v("#")]),this._v(" Pipeline Architecture")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"dictionary-and-hash-set-cache"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dictionary-and-hash-set-cache","aria-hidden":"true"}},[this._v("#")]),this._v(" Dictionary and Hash Set Cache")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"repositories"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#repositories","aria-hidden":"true"}},[this._v("#")]),this._v(" Repositories")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"decoupling-and-mocks"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#decoupling-and-mocks","aria-hidden":"true"}},[this._v("#")]),this._v(" Decoupling and mocks")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"aggregate-roots"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#aggregate-roots","aria-hidden":"true"}},[this._v("#")]),this._v(" Aggregate Roots")])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("Person related types")]),this._v(" "),t("li",[this._v("Reference Data types")]),this._v(" "),t("li",[this._v("Audit data")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"facade-for-event-processing"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#facade-for-event-processing","aria-hidden":"true"}},[this._v("#")]),this._v(" Facade for Event Processing")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"non-sql-data-stores"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#non-sql-data-stores","aria-hidden":"true"}},[this._v("#")]),this._v(" Non-SQL Data Stores")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"abstractions"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#abstractions","aria-hidden":"true"}},[this._v("#")]),this._v(" Abstractions")])},function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ul",[a("li",[e._v("ITemporal - the basis for temporal extension methods like IsCurrent() and CurrentOrNext()")]),e._v(" "),a("li",[e._v("IEntityKeyInfo - defines the minimum data for comparing incoming data to repository data and event evaluation. Enables the KeyCache.")]),e._v(" "),a("li",[e._v("IEventTarget - Allows generic handling of all incoming types via covariance")]),e._v(" "),a("li",[e._v("PersonActionable and RefDataActionable - enables the RepositorySelector so that the event handlers can pass data off to the correct repository")]),e._v(" "),a("li",[e._v("PersonAudit - Event store (audit trail) for downstream debugging and support")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("figcaption",[t("i",[this._v("(click to enlarge)")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"transforms-matching-the-models"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#transforms-matching-the-models","aria-hidden":"true"}},[this._v("#")]),this._v(" Transforms - Matching the Models")])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("Person records are dated in ESR (both past and future changes) but are not dated in HealthRoster. This means that EsrGo records multiple ESR versions internally, but outputs the a single version to HealthRoster depending on the date of extraction.")]),this._v(" "),t("li",[this._v("Assignments are dated in both systems, however in ESR end date is not always filled in. In HealthRoster, the end date is mandatory, so the interface must deduce a value. This is done by deducing the end date from the start of the subsequent record.")])])}],!1,null,null,null);r.options.__file="structure-and-design.md";t.default=r.exports}}]);